
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://synadia-labs.github.io/cross-system-jetstream-migration/cloud/">
      
      
        <link rel="prev" href="../leaf/">
      
      
        <link rel="next" href="../summary/">
      
      
      <link rel="icon" href="../static/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Cloud - Cross-System JetStream Migration</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <script defer data-domain="synadia-labs.github.io" src="https://plausible.io/js/script.hash.outbound-links.js"></script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#connect-the-leaf-node-to-the-synadia-cloud-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cross-System JetStream Migration" class="md-header__button md-logo" aria-label="Cross-System JetStream Migration" data-md-component="logo">
      
  <img src="../static/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cross-System JetStream Migration
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cloud
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/synadia-labs/cross-system-jetstream-migration" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    cross-system-jetstream-migration
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cross-System JetStream Migration" class="md-nav__button md-logo" aria-label="Cross-System JetStream Migration" data-md-component="logo">
      
  <img src="../static/favicon.png" alt="logo">

    </a>
    Cross-System JetStream Migration
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/synadia-labs/cross-system-jetstream-migration" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    cross-system-jetstream-migration
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Steps
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Steps
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../local/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Local
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../leaf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Leaf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Cloud
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Cloud
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#connect-the-leaf-node-to-the-synadia-cloud-system" class="md-nav__link">
    <span class="md-ellipsis">
      Connect the leaf node to the Synadia Cloud system
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-streams-in-synadia-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Create streams in Synadia Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-services-to-use-synadia-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate services to use Synadia Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-publisher-to-use-synadia-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate publisher to use Synadia Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disconnect-the-leaf-node" class="md-nav__link">
    <span class="md-ellipsis">
      Disconnect the leaf node
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Summary
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Resources
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#connect-the-leaf-node-to-the-synadia-cloud-system" class="md-nav__link">
    <span class="md-ellipsis">
      Connect the leaf node to the Synadia Cloud system
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-streams-in-synadia-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Create streams in Synadia Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-services-to-use-synadia-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate services to use Synadia Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-publisher-to-use-synadia-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate publisher to use Synadia Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disconnect-the-leaf-node" class="md-nav__link">
    <span class="md-ellipsis">
      Disconnect the leaf node
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Cloud</h1>

<h3 id="connect-the-leaf-node-to-the-synadia-cloud-system">Connect the leaf node to the Synadia Cloud system</h3>
<p>First things first, we need to download NATS user credentials to connect the leaf node to Synadia Cloud.</p>
<p>Navigate to the NATS User (<code>Team &gt; System &gt; Account &gt; NATS User</code>) you want to use to connect the local system to Synadia Cloud. Click <code>Get Connected</code> and download the credentials file. Save it to <code>./tf/cloud/cloud.creds</code>.</p>
<p>Uncomment the second <code>leafnodes.remotes</code> block in <code>leaf.conf</code> and restart the leaf node server.</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span>    {
<span class="w"> </span>      url: &quot;nats://localhost:7422&quot;
<span class="w"> </span>      credentials: &quot;.nsc/creds/local/A/admin.creds&quot;
<span class="w"> </span>    },
<span class="gd">-    # {</span>
<span class="gd">-    #   url: &quot;tls://connect.ngs.global&quot;</span>
<span class="gd">-    #   credentials: &quot;./tf/cloud/cloud.creds&quot;</span>
<span class="gd">-    #   account: A...</span>
<span class="gd">-    # }</span>
<span class="gi">+    {</span>
<span class="gi">+      url: &quot;tls://connect.ngs.global&quot;</span>
<span class="gi">+      credentials: &quot;./tf/cloud/cloud.creds&quot;</span>
<span class="gi">+      account: &quot;ABIV654V3C2AS4Y6NMZDPHVVOERHABHMBXNS2PFVSQQSGW6QIOQWR6FR&quot;</span>
<span class="gi">+    }</span>
</code></pre></div>
<p>Restart the NATS server (the <code>reload</code> signal is not supported when editing <code>leafnodes.remotes</code>, e.g. <code>nats-server –signal reload</code>).</p>
<p>Verify the leaf node shows up in the Synadia Cloud connections graph, under <code>Team &gt; System &gt; Account &gt; Connections</code>.</p>
<p><img alt="Synadia Cloud connection graphs showing the local NATS server connected as a leaf node" src="../static/connection-graph.png" /></p>
<h3 id="create-streams-in-synadia-cloud">Create streams in Synadia Cloud</h3>
<p>Create clones of the stream and consumers in Synadia Cloud using Terraform. This stream will use the original stream’s "interest" retention policy. Only the streams being sourced/mirroed <strong>from</strong> require the "limits" retention policy.</p>
<p>Note the use of <code>external.api</code> to map to the leaf node’s JetStream domain. This is required when sourcing across different NATS systems.</p>
<div class="highlight"><pre><span></span><code>❯<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>./tf/cloud
❯<span class="w"> </span>terraform<span class="w"> </span>apply<span class="w"> </span>-auto-approve<span class="w">  </span><span class="c1"># or `terraform plan -out plan.out` and `terraform apply plan.out`</span>

Terraform<span class="w"> </span>used<span class="w"> </span>the<span class="w"> </span>selected<span class="w"> </span>providers<span class="w"> </span>to<span class="w"> </span>generate<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>execution<span class="w"> </span>plan.<span class="w"> </span>Resource<span class="w"> </span>actions<span class="w"> </span>are<span class="w"> </span>indicated<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>symbols:
<span class="w">  </span>+<span class="w"> </span>create

Terraform<span class="w"> </span>will<span class="w"> </span>perform<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>actions:

<span class="w">  </span><span class="c1"># jetstream_consumer.ORDERS_cloud will be created</span>
<span class="w">  </span>+<span class="w"> </span>resource<span class="w"> </span><span class="s2">&quot;jetstream_consumer&quot;</span><span class="w"> </span><span class="s2">&quot;ORDERS_cloud&quot;</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>...
<span class="w">    </span><span class="o">}</span>

<span class="w">  </span><span class="c1"># jetstream_consumer.SHIPMENTS_cloud will be created</span>
<span class="w">  </span>+<span class="w"> </span>resource<span class="w"> </span><span class="s2">&quot;jetstream_consumer&quot;</span><span class="w"> </span><span class="s2">&quot;SHIPMENTS_cloud&quot;</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>...
<span class="w">    </span><span class="o">}</span>

<span class="w">  </span><span class="c1"># jetstream_stream.QUEUE_source will be created</span>
<span class="w">  </span>+<span class="w"> </span>resource<span class="w"> </span><span class="s2">&quot;jetstream_stream&quot;</span><span class="w"> </span><span class="s2">&quot;QUEUE_source&quot;</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>...
<span class="w">      </span>+<span class="w"> </span><span class="nv">retention</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;interest&quot;</span>

<span class="w">      </span>+<span class="w"> </span><span class="nb">source</span><span class="w"> </span><span class="o">{</span>
<span class="w">          </span>+<span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;QUEUE&quot;</span>

<span class="w">          </span>+<span class="w"> </span>external<span class="w"> </span><span class="o">{</span>
<span class="w">              </span>+<span class="w"> </span><span class="nv">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$JS</span><span class="s2">.leaf.API&quot;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>

Plan:<span class="w"> </span><span class="m">3</span><span class="w"> </span>to<span class="w"> </span>add,<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>change,<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>destroy.
jetstream_stream.QUEUE_source:<span class="w"> </span>Creating...
jetstream_stream.QUEUE_source:<span class="w"> </span>Creation<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>after<span class="w"> </span>1s<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE_source<span class="o">]</span>
jetstream_consumer.SHIPMENTS_cloud:<span class="w"> </span>Creating...
jetstream_consumer.ORDERS_cloud:<span class="w"> </span>Creating...
jetstream_consumer.ORDERS_cloud:<span class="w"> </span>Creation<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>after<span class="w"> </span>1s<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE_source_CONSUMER_ORDERS<span class="o">]</span>
jetstream_consumer.SHIPMENTS_cloud:<span class="w"> </span>Creation<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>after<span class="w"> </span>1s<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE_source_CONSUMER_SHIPMENTS<span class="o">]</span>

Apply<span class="w"> </span>complete!<span class="w"> </span>Resources:<span class="w"> </span><span class="m">3</span><span class="w"> </span>added,<span class="w"> </span><span class="m">0</span><span class="w"> </span>changed,<span class="w"> </span><span class="m">0</span><span class="w"> </span>destroyed.
</code></pre></div>
<p>View the created stream and consumers.</p>
<div class="highlight"><pre><span></span><code>❯<span class="w"> </span>nats<span class="w"> </span>--server<span class="w"> </span>tls://connect.ngs.global<span class="w"> </span>--creds<span class="w"> </span>tf/cloud/cloud.creds<span class="w"> </span>stream<span class="w"> </span>report
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│<span class="w">                                                </span>Stream<span class="w"> </span>Report<span class="w">                                                </span>│
├──────────────┬─────────┬───────────┬───────────┬──────────┬───────┬──────┬─────────┬────────────────────────┤
│<span class="w"> </span>Stream<span class="w">       </span>│<span class="w"> </span>Storage<span class="w"> </span>│<span class="w"> </span>Placement<span class="w"> </span>│<span class="w"> </span>Consumers<span class="w"> </span>│<span class="w"> </span>Messages<span class="w"> </span>│<span class="w"> </span>Bytes<span class="w"> </span>│<span class="w"> </span>Lost<span class="w"> </span>│<span class="w"> </span>Deleted<span class="w"> </span>│<span class="w"> </span>Replicas<span class="w">               </span>│
├──────────────┼─────────┼───────────┼───────────┼──────────┼───────┼──────┼─────────┼────────────────────────┤
│<span class="w"> </span>QUEUE_source<span class="w"> </span>│<span class="w"> </span>File<span class="w">    </span>│<span class="w">           </span>│<span class="w"> </span><span class="m">2</span><span class="w">         </span>│<span class="w"> </span><span class="m">0</span><span class="w">        </span>│<span class="w"> </span><span class="m">0</span><span class="w"> </span>B<span class="w">   </span>│<span class="w"> </span><span class="m">0</span><span class="w">    </span>│<span class="w"> </span><span class="m">0</span><span class="w">       </span>│<span class="w"> </span>aws-uswest2-natscj1-1*<span class="w"> </span>│
╰──────────────┴─────────┴───────────┴───────────┴──────────┴───────┴──────┴─────────┴────────────────────────╯

╭────────────────────────────────────────────────────────────────────────────────────────────────────╮
│<span class="w">                                         </span>Replication<span class="w"> </span>Report<span class="w">                                         </span>│
├──────────────┬────────┬────────────┬───────────────┬────────────────────────┬────────┬─────┬───────┤
│<span class="w"> </span>Stream<span class="w">       </span>│<span class="w"> </span>Kind<span class="w">   </span>│<span class="w"> </span>API<span class="w"> </span>Prefix<span class="w"> </span>│<span class="w"> </span>Source<span class="w"> </span>Stream<span class="w"> </span>│<span class="w"> </span>Filters<span class="w"> </span>and<span class="w"> </span>Transforms<span class="w"> </span>│<span class="w"> </span>Active<span class="w"> </span>│<span class="w"> </span>Lag<span class="w"> </span>│<span class="w"> </span>Error<span class="w"> </span>│
├──────────────┼────────┼────────────┼───────────────┼────────────────────────┼────────┼─────┼───────┤
│<span class="w"> </span>QUEUE_source<span class="w"> </span>│<span class="w"> </span>Source<span class="w"> </span>│<span class="w">            </span>│<span class="w"> </span>QUEUE<span class="w">         </span>│<span class="w">                        </span>│<span class="w"> </span>0s<span class="w">     </span>│<span class="w"> </span><span class="m">0</span><span class="w">   </span>│<span class="w">       </span>│
╰──────────────┴────────┴────────────┴───────────────┴────────────────────────┴────────┴─────┴───────╯

❯<span class="w"> </span>nats<span class="w"> </span>--server<span class="w"> </span>tls://connect.ngs.global<span class="w"> </span>--creds<span class="w"> </span>tf/cloud/cloud.creds<span class="w"> </span>consumer<span class="w"> </span>report<span class="w"> </span>QUEUE_source
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│<span class="w">                                    </span>Consumer<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span>QUEUE_source<span class="w"> </span>with<span class="w"> </span><span class="m">2</span><span class="w"> </span>consumers<span class="w">                                    </span>│
├───────────┬──────┬────────────┬──────────┬─────────────┬─────────────┬─────────────┬───────────┬────────────────────────┤
│<span class="w"> </span>Consumer<span class="w">  </span>│<span class="w"> </span>Mode<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Policy<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Wait<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Pending<span class="w"> </span>│<span class="w"> </span>Redelivered<span class="w"> </span>│<span class="w"> </span>Unprocessed<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Floor<span class="w"> </span>│<span class="w"> </span>Cluster<span class="w">                </span>│
├───────────┼──────┼────────────┼──────────┼─────────────┼─────────────┼─────────────┼───────────┼────────────────────────┤
│<span class="w"> </span>ORDERS<span class="w">    </span>│<span class="w"> </span>Pull<span class="w"> </span>│<span class="w"> </span>Explicit<span class="w">   </span>│<span class="w"> </span><span class="m">30</span>.00s<span class="w">   </span>│<span class="w"> </span><span class="m">0</span><span class="w">           </span>│<span class="w"> </span><span class="m">0</span><span class="w">           </span>│<span class="w"> </span><span class="m">0</span><span class="w">           </span>│<span class="w"> </span><span class="m">0</span><span class="w">         </span>│<span class="w"> </span>aws-uswest2-natscj1-1*<span class="w"> </span>│
│<span class="w"> </span>SHIPMENTS<span class="w"> </span>│<span class="w"> </span>Pull<span class="w"> </span>│<span class="w"> </span>Explicit<span class="w">   </span>│<span class="w"> </span><span class="m">30</span>.00s<span class="w">   </span>│<span class="w"> </span><span class="m">0</span><span class="w">           </span>│<span class="w"> </span><span class="m">0</span><span class="w">           </span>│<span class="w"> </span><span class="m">0</span><span class="w">           </span>│<span class="w"> </span><span class="m">0</span><span class="w">         </span>│<span class="w"> </span>aws-uswest2-natscj1-1*<span class="w"> </span>│
╰───────────┴──────┴────────────┴──────────┴─────────────┴─────────────┴─────────────┴───────────┴────────────────────────╯
</code></pre></div>
<p>You can also see the stream in Synadia Cloud.</p>
<p><img alt="Synadia Cloud stream" src="../static/stream.png" /></p>
<h3 id="migrate-services-to-use-synadia-cloud">Migrate services to use Synadia Cloud</h3>
<p>In general, updating services will depend on how the services interact with NATS. For this example walkthrough, we will update the <code>.env</code> values and restart the services.</p>
<div class="highlight"><pre><span></span><code><span class="gd">- NATS_URL=nats://localhost:4222</span>
<span class="gd">- NATS_CREDS_PATH=.nsc/creds/local/A/admin.creds</span>
<span class="gi">+ NATS_URL=tls://connect.ngs.global</span>
<span class="gi">+ NATS_CREDS_PATH=tf/cloud/cloud.creds</span>
</code></pre></div>
<p>Restart the <code>orders</code> and <code>shipments</code> services. Verify they are connected in the Synadia Cloud connections tab.</p>
<p><img alt="orders and shipments connected to Synadia Cloud in the connection graph" src="../static/connection-graph-consumers.png" /></p>
<p>Verify messages are being processed using the NATS CLI.
<div class="highlight"><pre><span></span><code>╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│<span class="w">                                                </span>Stream<span class="w"> </span>Report<span class="w">                                                </span>│
├──────────────┬─────────┬───────────┬───────────┬──────────┬────────┬──────┬─────────┬───────────────────────┤
│<span class="w"> </span>Stream<span class="w">       </span>│<span class="w"> </span>Storage<span class="w"> </span>│<span class="w"> </span>Placement<span class="w"> </span>│<span class="w"> </span>Consumers<span class="w"> </span>│<span class="w"> </span>Messages<span class="w"> </span>│<span class="w"> </span>Bytes<span class="w">  </span>│<span class="w"> </span>Lost<span class="w"> </span>│<span class="w"> </span>Deleted<span class="w"> </span>│<span class="w"> </span>Replicas<span class="w">              </span>│
├──────────────┼─────────┼───────────┼───────────┼──────────┼────────┼──────┼─────────┼───────────────────────┤
│<span class="w"> </span>QUEUE_source<span class="w"> </span>│<span class="w"> </span>File<span class="w">    </span>│<span class="w">           </span>│<span class="w"> </span><span class="m">2</span><span class="w">         </span>│<span class="w"> </span><span class="m">248</span><span class="w">      </span>│<span class="w"> </span><span class="m">27</span><span class="w"> </span>KiB<span class="w"> </span>│<span class="w"> </span><span class="m">0</span><span class="w">    </span>│<span class="w"> </span><span class="m">25</span><span class="w">      </span>│<span class="w"> </span>az-uswest2-natscj1-2*<span class="w"> </span>│
╰──────────────┴─────────┴───────────┴───────────┴──────────┴────────┴──────┴─────────┴───────────────────────╯

╭──────────────────────────────────────────────────────────────────────────────────────────────────────╮
│<span class="w">                                          </span>Replication<span class="w"> </span>Report<span class="w">                                          </span>│
├──────────────┬────────┬──────────────┬───────────────┬────────────────────────┬────────┬─────┬───────┤
│<span class="w"> </span>Stream<span class="w">       </span>│<span class="w"> </span>Kind<span class="w">   </span>│<span class="w"> </span>API<span class="w"> </span>Prefix<span class="w">   </span>│<span class="w"> </span>Source<span class="w"> </span>Stream<span class="w"> </span>│<span class="w"> </span>Filters<span class="w"> </span>and<span class="w"> </span>Transforms<span class="w"> </span>│<span class="w"> </span>Active<span class="w"> </span>│<span class="w"> </span>Lag<span class="w"> </span>│<span class="w"> </span>Error<span class="w"> </span>│
├──────────────┼────────┼──────────────┼───────────────┼────────────────────────┼────────┼─────┼───────┤
│<span class="w"> </span>QUEUE_source<span class="w"> </span>│<span class="w"> </span>Source<span class="w"> </span>│<span class="w"> </span><span class="nv">$JS</span>.leaf.API<span class="w"> </span>│<span class="w"> </span>QUEUE<span class="w">         </span>│<span class="w">                        </span>│<span class="w"> </span>57ms<span class="w">   </span>│<span class="w"> </span><span class="m">0</span><span class="w">   </span>│<span class="w">       </span>│
╰──────────────┴────────┴──────────────┴───────────────┴────────────────────────┴────────┴─────┴───────╯

❯<span class="w"> </span>nats<span class="w"> </span>--server<span class="w"> </span>tls://connect.ngs.global<span class="w"> </span>--creds<span class="w"> </span>tf/cloud/cloud.creds<span class="w"> </span>consumer<span class="w"> </span>report<span class="w"> </span>QUEUE_source
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│<span class="w">                                    </span>Consumer<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span>QUEUE_source<span class="w"> </span>with<span class="w"> </span><span class="m">2</span><span class="w"> </span>consumers<span class="w">                                   </span>│
├───────────┬──────┬────────────┬──────────┬─────────────┬─────────────┬─────────────┬───────────┬───────────────────────┤
│<span class="w"> </span>Consumer<span class="w">  </span>│<span class="w"> </span>Mode<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Policy<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Wait<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Pending<span class="w"> </span>│<span class="w"> </span>Redelivered<span class="w"> </span>│<span class="w"> </span>Unprocessed<span class="w"> </span>│<span class="w"> </span>Ack<span class="w"> </span>Floor<span class="w"> </span>│<span class="w"> </span>Cluster<span class="w">               </span>│
├───────────┼──────┼────────────┼──────────┼─────────────┼─────────────┼─────────────┼───────────┼───────────────────────┤
│<span class="w"> </span>ORDERS<span class="w">    </span>│<span class="w"> </span>Pull<span class="w"> </span>│<span class="w"> </span>Explicit<span class="w">   </span>│<span class="w"> </span><span class="m">30</span>.00s<span class="w">   </span>│<span class="w"> </span><span class="m">113</span><span class="w">         </span>│<span class="w"> </span><span class="m">96</span><span class="w">          </span>│<span class="w"> </span><span class="m">27</span><span class="w"> </span>/<span class="w"> </span><span class="m">10</span>%<span class="w">    </span>│<span class="w"> </span><span class="m">226</span><span class="w">       </span>│<span class="w"> </span>az-uswest2-natscj1-2*<span class="w"> </span>│
│<span class="w"> </span>SHIPMENTS<span class="w"> </span>│<span class="w"> </span>Pull<span class="w"> </span>│<span class="w"> </span>Explicit<span class="w">   </span>│<span class="w"> </span><span class="m">30</span>.00s<span class="w">   </span>│<span class="w"> </span><span class="m">83</span><span class="w">          </span>│<span class="w"> </span><span class="m">70</span><span class="w">          </span>│<span class="w"> </span><span class="m">29</span><span class="w"> </span>/<span class="w"> </span><span class="m">11</span>%<span class="w">    </span>│<span class="w"> </span><span class="m">167</span><span class="w">       </span>│<span class="w"> </span>az-uswest2-natscj1-2*<span class="w"> </span>│
╰───────────┴──────┴────────────┴──────────┴─────────────┴─────────────┴─────────────┴───────────┴───────────────────────╯
</code></pre></div></p>
<h3 id="migrate-publisher-to-use-synadia-cloud">Migrate publisher to use Synadia Cloud</h3>
<p>Update the Synadia Cloud stream to listen on the same subjects as its self-managed counterparts.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tf/cloud/cloud.td</span>
<span class="n">resource</span><span class="w"> </span><span class="s2">&quot;jetstream_stream&quot;</span><span class="w"> </span><span class="s2">&quot;QUEUE&quot;</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;QUEUE&quot;</span>
<span class="w">  </span><span class="n">subjects</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;QUEUE.&gt;&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># &lt;-- add this line</span>
<span class="w">  </span><span class="p">...</span>
<span class="err">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>❯<span class="w"> </span>terraform<span class="w"> </span>apply<span class="w"> </span>-auto-approve
jetstream_stream.QUEUE:<span class="w"> </span>Refreshing<span class="w"> </span>state...<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE<span class="o">]</span>
jetstream_consumer.SHIPMENTS_cloud:<span class="w"> </span>Refreshing<span class="w"> </span>state...<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE_CONSUMER_SHIPMENTS<span class="o">]</span>
jetstream_consumer.ORDERS_cloud:<span class="w"> </span>Refreshing<span class="w"> </span>state...<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE_CONSUMER_ORDERS<span class="o">]</span>

Terraform<span class="w"> </span>used<span class="w"> </span>the<span class="w"> </span>selected<span class="w"> </span>providers<span class="w"> </span>to<span class="w"> </span>generate<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>execution<span class="w"> </span>plan.<span class="w"> </span>Resource<span class="w"> </span>actions<span class="w"> </span>are<span class="w"> </span>indicated<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>symbols:
<span class="w">  </span>~<span class="w"> </span>update<span class="w"> </span><span class="k">in</span>-place

Terraform<span class="w"> </span>will<span class="w"> </span>perform<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>actions:

<span class="w">  </span><span class="c1"># jetstream_stream.QUEUE will be updated in-place</span>
<span class="w">  </span>~<span class="w"> </span>resource<span class="w"> </span><span class="s2">&quot;jetstream_stream&quot;</span><span class="w"> </span><span class="s2">&quot;QUEUE&quot;</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nv">id</span><span class="w">                        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;JETSTREAM_STREAM_QUEUE&quot;</span>
<span class="w">        </span><span class="nv">name</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;QUEUE&quot;</span>
<span class="w">      </span>~<span class="w"> </span><span class="nv">subjects</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">          </span>+<span class="w"> </span><span class="s2">&quot;QUEUE.&gt;&quot;</span>,
<span class="w">        </span><span class="o">]</span>
<span class="w">        </span><span class="c1"># (24 unchanged attributes hidden)</span>

<span class="w">        </span><span class="c1"># (1 unchanged block hidden)</span>
<span class="w">    </span><span class="o">}</span>

Plan:<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>add,<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>change,<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>destroy.
jetstream_stream.QUEUE:<span class="w"> </span>Modifying...<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE<span class="o">]</span>
jetstream_stream.QUEUE:<span class="w"> </span>Modifications<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>after<span class="w"> </span>1s<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>JETSTREAM_STREAM_QUEUE<span class="o">]</span>

Apply<span class="w"> </span>complete!<span class="w"> </span>Resources:<span class="w"> </span><span class="m">0</span><span class="w"> </span>added,<span class="w"> </span><span class="m">1</span><span class="w"> </span>changed,<span class="w"> </span><span class="m">0</span><span class="w"> </span>destroyed.
</code></pre></div>
<p>At this point, the Synadia Cloud stream will be sourcing messages from the leaf node stream and ingesting messages on the NATS subject. The on-premise stream will continue ingesting messages due to interest propagation across the leaf node connection. Minimizing the time the stream ingest messages in both ways will lower the number of potential duplicate messages processed by the downstream services.</p>
<p>Verify the Synadia Cloud stream is both ingesting messages from the publishers and the services are processing messages from the streams/consumers.</p>
<p><img alt="All NATS micro services connected to Synadia Cloud, shown in the connection graph" src="../static/connection-graph-publisher.png" /></p>
<h3 id="disconnect-the-leaf-node">Disconnect the leaf node</h3>
<p>Once you have verified all streams and consumers are migrated to Synadia Cloud and the publisher and services are working, you can disconnect and turn off the leaf node system. To disconnect it from the self-managed and Synadia Cloud systems, simply remove the <code>leafnodes</code> block from its server config and restart. You can also dispose of the leaf node system entirely.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../leaf/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Leaf">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Leaf
              </div>
            </div>
          </a>
        
        
          
          <a href="../summary/" class="md-footer__link md-footer__link--next" aria-label="Next: Summary">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Summary
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.footer"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>